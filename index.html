<!doctype html>
<html lang="he" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>JSON Viewer (Monaco Debug)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.49.0/min/vs/loader.js"></script>
  <style>
    :root { color-scheme: light dark }
    html,body,#editor{ height:100% }
    body{ margin:0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace }
    #copy-fab{
      position:fixed; bottom:24px; right:24px; z-index:9999;
      width:48px; height:48px; border-radius:50%;
      background:var(--tg-theme-button-color, #3390ec);
      color:var(--tg-theme-button-text-color, #fff);
      border:none; cursor:pointer;
      font-size:22px; display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 8px rgba(0,0,0,.3);
    }
    #debug{
      position:fixed; top:0; left:0; right:0; z-index:9999;
      background:rgba(0,0,0,.85); color:#0f0; font-size:11px;
      padding:8px; max-height:40vh; overflow:auto; display:none;
    }
  </style>
</head>
<body>
<div id="debug"></div>
<div id="editor"></div>
<button id="copy-fab" onclick="copyAll()">ðŸ“‹</button>

<script>
(function(){ try{Telegram.WebApp.expand()}catch(_){} })();

var debugEl;
var debugLines = [];
function dbg(msg){
  debugLines.push(new Date().toISOString().substr(11,8) + ' ' + msg);
  if (debugLines.length > 20) debugLines.shift();
  if (debugEl) {
    debugEl.style.display = 'block';
    debugEl.textContent = debugLines.join('\n');
  }
}

function readToken(){
  var q = new URLSearchParams(location.search).get('data');
  if (q) return q;
  var h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
  if (!h) return null;
  if (h.includes('=')) {
    var hp = new URLSearchParams(h);
    if (hp.get('data')) return hp.get('data');
    if (hp.get('d')) return hp.get('d');
  }
  return h.split(/[&#?]/,1)[0];
}
function fromB64UrlSafe(v){
  v = decodeURIComponent(v);
  v = v.replace(/[^A-Za-z0-9\-_]/g,'').replace(/-/g,'+').replace(/_/g,'/');
  var pad = v.length % 4; if (pad) v += '='.repeat(4-pad);
  var bin = atob(v);
  var bytes = new Uint8Array(bin.length);
  for (var i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return new TextDecoder('utf-8').decode(bytes);
}

var lastPretty='';
var parsedJson=null;

function prepare(){
  var tok = readToken();
  if (!tok){ lastPretty=''; parsedJson=null; return; }
  try{
    var raw = fromB64UrlSafe(tok);
    try{ parsedJson = JSON.parse(raw); lastPretty = JSON.stringify(parsedJson, null, 2); }
    catch(e){ lastPretty = raw; parsedJson=null; }
  }catch(e){ lastPretty = 'Failed to decode: '+String(e); parsedJson=null; }
}

function copyAll(){
  navigator.clipboard.writeText(lastPretty).then(function(){
    dbg('copyAll OK');
  }).catch(function(e){ dbg('copyAll FAIL: '+e); });
}

// Build line map from pretty JSON
function buildLineMap(json, pretty){
  var map = {};
  if (!json || typeof json !== 'object') return map;
  var lines = pretty.split('\n');
  var used = {};

  function visit(obj){
    if (obj === null || typeof obj !== 'object' || Array.isArray(obj)) return;
    Object.keys(obj).forEach(function(k){
      var val = obj[k];
      var needle = '"' + k + '"';
      for (var i = 0; i < lines.length; i++){
        if (used[i]) continue;
        var line = lines[i];
        // Must contain "key": pattern
        var idx = line.indexOf(needle);
        if (idx !== -1 && line.indexOf(':', idx + needle.length) !== -1){
          var copyVal = (val !== null && typeof val === 'object') ? JSON.stringify(val, null, 2) : String(val);
          map[i + 1] = { key: k, value: copyVal };
          used[i] = true;
          break;
        }
      }
      if (val && typeof val === 'object') visit(val);
    });
  }
  visit(json);
  return map;
}

var lineMap = {};
var editorInstance = null;

var CDN = 'https://unpkg.com/monaco-editor@0.49.0/min';
require.config({ paths: { vs: CDN + '/vs' } });
window.MonacoEnvironment = {
  getWorkerUrl: function(){ return 'data:text/javascript;charset=utf-8,' + encodeURIComponent(
    "self.MonacoEnvironment={baseUrl:'" + CDN + "/'};importScripts('" + CDN + "/vs/base/worker/workerMain.js');"
  ); }
};

function render(){
  debugEl = document.getElementById('debug');
  prepare();
  lineMap = buildLineMap(parsedJson, lastPretty);
  dbg('lineMap built: ' + Object.keys(lineMap).length + ' entries');
  dbg('lineMap keys: ' + JSON.stringify(Object.keys(lineMap)));

  var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  require(['vs/editor/editor.main'], function(){
    document.getElementById('editor').innerHTML = '';
    editorInstance = monaco.editor.create(document.getElementById('editor'), {
      value: lastPretty,
      language: 'json',
      readOnly: true,
      domReadOnly: true,
      automaticLayout: true,
      wordWrap: 'on',
      minimap: { enabled: false },
      theme: prefersDark ? 'vs-dark' : 'vs',
      folding: true,
      lineNumbers: 'off',
      scrollBeyondLastLine: false
    });

    // Test 1: Monaco onMouseDown
    editorInstance.onMouseDown(function(e){
      var tgtPos = e.target && e.target.position;
      var tgtType = e.target && e.target.type;
      dbg('onMouseDown type=' + tgtType + ' pos=' + JSON.stringify(tgtPos));
      if (tgtPos) {
        var info = lineMap[tgtPos.lineNumber];
        dbg('  lineMap[' + tgtPos.lineNumber + ']=' + (info ? info.key : 'NONE'));
        if (info) {
          navigator.clipboard.writeText(info.value).then(function(){
            dbg('  COPY OK: ' + info.key);
          }).catch(function(err){
            dbg('  COPY FAIL clipboard: ' + err);
            // fallback
            var ta = document.createElement('textarea');
            ta.value = info.value;
            ta.style.cssText = 'position:fixed;left:-9999px;opacity:0';
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            var ok = document.execCommand('copy');
            dbg('  execCommand fallback: ' + ok);
            document.body.removeChild(ta);
          });
        }
      }
    });

    // Test 2: onDidChangeCursorPosition
    editorInstance.onDidChangeCursorPosition(function(e){
      dbg('cursorChange line=' + e.position.lineNumber + ' reason=' + e.reason);
    });

    // Test 3: raw DOM events on editor
    var edDom = document.getElementById('editor');
    edDom.addEventListener('touchend', function(e){
      dbg('DOM touchend');
    });
    edDom.addEventListener('click', function(e){
      var pos = editorInstance.getPosition();
      dbg('DOM click, getPosition=' + JSON.stringify(pos));
    });

    dbg('Monaco ready');
  });
}

window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
