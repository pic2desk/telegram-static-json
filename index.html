<!doctype html>
<html lang="he" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>JSON Viewer (Monaco, clean)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.49.0/min/vs/loader.js"></script>
  <style>
    :root { color-scheme: light dark }
    html,body,#editor{ height:100% }
    body{ margin:0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace }
    #copy-fab{
      position:fixed; bottom:24px; right:24px; z-index:9999;
      width:48px; height:48px; border-radius:50%;
      background:var(--tg-theme-button-color, #3390ec);
      color:var(--tg-theme-button-text-color, #fff);
      border:none; cursor:pointer;
      font-size:22px; display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 8px rgba(0,0,0,.3);
      transition: transform .15s;
    }
    #copy-fab:active{ transform:scale(.9) }
  </style>
</head>
<body>
<div id="editor"></div>
<button id="copy-fab" onclick="showCopyMenu()">ðŸ“‹</button>

<script>
(function(){ try{Telegram.WebApp.expand()}catch(_){} })();

// === ×©×ž×™×¨×ª ×¦×•×¨×ª ×§×‘×œ×ª ×”×ž×™×“×¢ ×‘×“×™×•×§ ×›×¤×™ ×©×‘×™×§×©×ª ===
function readToken(){
  const q = new URLSearchParams(location.search).get('data');
  if (q) return q;
  const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
  if (!h) return null;
  if (h.includes('=')) {
    const hp = new URLSearchParams(h);
    if (hp.get('data')) return hp.get('data');
    if (hp.get('d')) return hp.get('d');
  }
  return h.split(/[&#?]/,1)[0];
}
function fromB64UrlSafe(v){
  v = decodeURIComponent(v);
  v = v.replace(/[^A-Za-z0-9\-_]/g,'').replace(/-/g,'+').replace(/_/g,'/');
  const pad = v.length % 4; if (pad) v += '='.repeat(4-pad);
  const bin = atob(v);
  const bytes = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return new TextDecoder('utf-8').decode(bytes);
}
// === ×¡×•×£ ×§×•×“ ×”×§×‘×œ×” ===

let lastPretty='';
let parsedJson=null;

function prepare(){
  const tok = readToken();
  if (!tok){ lastPretty=''; parsedJson=null; return; }
  try{
    const raw = fromB64UrlSafe(tok);
    try{ parsedJson = JSON.parse(raw); lastPretty = JSON.stringify(parsedJson, null, 2); }
    catch{ lastPretty = raw; parsedJson=null; }
  }catch(e){ lastPretty = 'Failed to decode: '+String(e); parsedJson=null; }
}

// Copy helpers
function copyText(text){
  navigator.clipboard.writeText(text).then(function(){
    try{ Telegram.WebApp.showAlert('Copied âœ“'); }catch(_){}
  }).catch(function(){
    try{ Telegram.WebApp.showAlert('Copy failed'); }catch(_){}
  });
}

function extractValue(key){
  if (!parsedJson) return null;
  if (key === 'all') return lastPretty;
  if (key === 'machineId') return parsedJson.environment && parsedJson.environment.machineId || null;
  if (key === 'properties') return parsedJson.properties ? JSON.stringify(parsedJson.properties, null, 2) : null;
  if (key === 'message') return parsedJson.message || null;
  return null;
}

function showCopyMenu(){
  if (!parsedJson){
    copyText(lastPretty);
    return;
  }

  var buttons = [{ id:'all', type:'default', text:'Copy All' }];
  if (parsedJson.environment && parsedJson.environment.machineId)
    buttons.push({ id:'machineId', type:'default', text:'Copy Machine ID' });
  if (parsedJson.message)
    buttons.push({ id:'message', type:'default', text:'Copy Message' });
  if (parsedJson.properties)
    buttons.push({ id:'properties', type:'default', text:'Copy Properties' });

  try{
    Telegram.WebApp.showPopup({ title:'Copy', message:'Select what to copy', buttons:buttons }, function(id){
      if (!id) return;
      var val = extractValue(id);
      if (val) copyText(val);
    });
  }catch(_){
    // Fallback: copy all
    copyText(lastPretty);
  }
}

// Monaco config
const CDN = 'https://unpkg.com/monaco-editor@0.49.0/min';
require.config({ paths: { vs: CDN + '/vs' } });
window.MonacoEnvironment = {
  getWorkerUrl: function(){ return 'data:text/javascript;charset=utf-8,' + encodeURIComponent(
    "self.MonacoEnvironment={baseUrl:'" + CDN + "/'};importScripts('" + CDN + "/vs/base/worker/workerMain.js');"
  ); }
};

function render(){
  prepare();
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  require(['vs/editor/editor.main'], function(){
    monaco.editor.create(document.getElementById('editor'), {
      value: lastPretty,
      language: 'json',
      readOnly: true,
      automaticLayout: true,
      wordWrap: 'on',
      minimap: { enabled: false },
      theme: prefersDark ? 'vs-dark' : 'vs',
      folding: true,
      lineNumbers: 'off',
      scrollBeyondLastLine: false
    });
  });
}

window.addEventListener('hashchange', render);
window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
